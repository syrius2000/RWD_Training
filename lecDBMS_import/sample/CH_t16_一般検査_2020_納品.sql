USE VACCINE;

DROP TABLE IF EXISTS 一般検査;

CREATE TABLE 一般検査(
    PATIENTNO VARCHAR(20) NULL,            -- 患者番号
    COLLECTDATE DATE NULL,                 -- 収集日 (YYYYMMDD形式)
    COLLECTTIME TIME NULL,                 -- 収集時刻 (HHMI形式)
    TESTITEMCODE VARCHAR(20) NULL,         -- 検査項目コード
    TESTITEMNAME VARCHAR(100) NULL,        -- 検査項目名
    ADDCOMMENT1 VARCHAR(255) NULL,         -- 追加コメント1
    ADDCOMMENT2 VARCHAR(255) NULL,         -- 追加コメント2
    OUTOFSTANDARD VARCHAR(10) NULL,        -- 基準外フラグ
    REPORTVALUE VARCHAR(255) NULL,         -- 報告値
    MATERIALSNAME VARCHAR(50) NULL,        -- 材料名
    EDITORIALRESULT VARCHAR(255) NULL,     -- 編集結果
    SPECIMENCOMMENTFLG VARCHAR(10) NULL    -- 検体コメントフラグ
    -- 主キーはデータの内容により慎重に決定してください。
    -- ここでは例として複合主キーを設定します。
    -- PRIMARY KEY (PATIENTNO, COLLECTDATE, COLLECTTIME, TESTITEMCODE)
);

-- SHOW TABLES;
DESCRIBE 一般検査;

-- LOAD DATA INFILE '/Users/myamaguchi/Data/Vaccin/CH_t16_一般検査_2020_納品.txt' -- 1つ目のCSVファイルのフルパス
LOAD DATA INFILE '/tmp/CH_t16_一般検査_2020_納品.txt' -- 1つ目のCSVファイルのフルパス
INTO TABLE 一般検査
CHARACTER SET CP932
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS
(
    @PATIENTNO_STR,
    @COLLECTDATE_STR,
    @COLLECTTIME_STR,
    @TESTITEMCODE_STR,
    @TESTITEMNAME_STR,
    @ADDCOMMENT1_STR,
    @ADDCOMMENT2_STR,
    @OUTOFSTANDARD_STR,
    @REPORTVALUE_STR,
    @MATERIALSNAME_STR,
    @EDITORIALRESULT_STR,
    @SPECIMENCOMMENTFLG_STR
)
SET
    -- VARCHAR型カラムの処理: 空文字列の場合NULLに変換
    PATIENTNO = NULLIF(@PATIENTNO_STR, ''),
    TESTITEMCODE = NULLIF(@TESTITEMCODE_STR, ''),
    TESTITEMNAME = NULLIF(@TESTITEMNAME_STR, ''),
    ADDCOMMENT1 = NULLIF(@ADDCOMMENT1_STR, ''),
    ADDCOMMENT2 = NULLIF(@ADDCOMMENT2_STR, ''),
    OUTOFSTANDARD = NULLIF(@OUTOFSTANDARD_STR, ''),
    REPORTVALUE = NULLIF(@REPORTVALUE_STR, ''),
    MATERIALSNAME = NULLIF(@MATERIALSNAME_STR, ''),
    EDITORIALRESULT = NULLIF(@EDITORIALRESULT_STR, ''),
    SPECIMENCOMMENTFLG = NULLIF(@SPECIMENCOMMENTFLG_STR, ''),

    -- DATE型カラムの処理: 空文字列の場合NULLに変換 (YYYYMMDD形式)
    COLLECTDATE = STR_TO_DATE(NULLIF(@COLLECTDATE_STR, ''), '%Y%m%d'),

    -- TIME型カラムの処理: 空文字列の場合NULLに変換 (HHMI形式)
    COLLECTTIME = STR_TO_DATE(NULLIF(@COLLECTTIME_STR, ''), '%H%i');


LOAD DATA INFILE '/tmp/CH_t16_一般検査_2021_納品.txt'
INTO TABLE 一般検査
CHARACTER SET CP932
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS
(
    @PATIENTNO_STR,
    @COLLECTDATE_STR,
    @COLLECTTIME_STR,
    @TESTITEMCODE_STR,
    @TESTITEMNAME_STR,
    @ADDCOMMENT1_STR,
    @ADDCOMMENT2_STR,
    @OUTOFSTANDARD_STR,
    @REPORTVALUE_STR,
    @MATERIALSNAME_STR,
    @EDITORIALRESULT_STR,
    @SPECIMENCOMMENTFLG_STR
)
SET
    -- VARCHAR型カラムの処理: 空文字列の場合NULLに変換
    PATIENTNO = NULLIF(@PATIENTNO_STR, ''),
    TESTITEMCODE = NULLIF(@TESTITEMCODE_STR, ''),
    TESTITEMNAME = NULLIF(@TESTITEMNAME_STR, ''),
    ADDCOMMENT1 = NULLIF(@ADDCOMMENT1_STR, ''),
    ADDCOMMENT2 = NULLIF(@ADDCOMMENT2_STR, ''),
    OUTOFSTANDARD = NULLIF(@OUTOFSTANDARD_STR, ''),
    REPORTVALUE = NULLIF(@REPORTVALUE_STR, ''),
    MATERIALSNAME = NULLIF(@MATERIALSNAME_STR, ''),
    EDITORIALRESULT = NULLIF(@EDITORIALRESULT_STR, ''),
    SPECIMENCOMMENTFLG = NULLIF(@SPECIMENCOMMENTFLG_STR, ''),

    -- DATE型カラムの処理: 空文字列の場合NULLに変換 (YYYYMMDD形式)
    COLLECTDATE = STR_TO_DATE(NULLIF(@COLLECTDATE_STR, ''), '%Y%m%d'),

    -- TIME型カラムの処理: 空文字列の場合NULLに変換 (HHMI形式)
    COLLECTTIME = STR_TO_DATE(NULLIF(@COLLECTTIME_STR, ''), '%H%i');

LOAD DATA INFILE '/tmp/CH_t16_一般検査_2022_納品.txt'
INTO TABLE 一般検査
CHARACTER SET CP932
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS
(
    @PATIENTNO_STR,
    @COLLECTDATE_STR,
    @COLLECTTIME_STR,
    @TESTITEMCODE_STR,
    @TESTITEMNAME_STR,
    @ADDCOMMENT1_STR,
    @ADDCOMMENT2_STR,
    @OUTOFSTANDARD_STR,
    @REPORTVALUE_STR,
    @MATERIALSNAME_STR,
    @EDITORIALRESULT_STR,
    @SPECIMENCOMMENTFLG_STR
)
SET
    -- VARCHAR型カラムの処理: 空文字列の場合NULLに変換
    PATIENTNO = NULLIF(@PATIENTNO_STR, ''),
    TESTITEMCODE = NULLIF(@TESTITEMCODE_STR, ''),
    TESTITEMNAME = NULLIF(@TESTITEMNAME_STR, ''),
    ADDCOMMENT1 = NULLIF(@ADDCOMMENT1_STR, ''),
    ADDCOMMENT2 = NULLIF(@ADDCOMMENT2_STR, ''),
    OUTOFSTANDARD = NULLIF(@OUTOFSTANDARD_STR, ''),
    REPORTVALUE = NULLIF(@REPORTVALUE_STR, ''),
    MATERIALSNAME = NULLIF(@MATERIALSNAME_STR, ''),
    EDITORIALRESULT = NULLIF(@EDITORIALRESULT_STR, ''),
    SPECIMENCOMMENTFLG = NULLIF(@SPECIMENCOMMENTFLG_STR, ''),

    -- DATE型カラムの処理: 空文字列の場合NULLに変換 (YYYYMMDD形式)
    COLLECTDATE = STR_TO_DATE(NULLIF(@COLLECTDATE_STR, ''), '%Y%m%d'),

    -- TIME型カラムの処理: 空文字列の場合NULLに変換 (HHMI形式)
    COLLECTTIME = STR_TO_DATE(NULLIF(@COLLECTTIME_STR, ''), '%H%i');


LOAD DATA INFILE '/tmp/CH_t16_一般検査_2023_納品.txt'
INTO TABLE 一般検査
CHARACTER SET CP932
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS
(
    @PATIENTNO_STR,
    @COLLECTDATE_STR,
    @COLLECTTIME_STR,
    @TESTITEMCODE_STR,
    @TESTITEMNAME_STR,
    @ADDCOMMENT1_STR,
    @ADDCOMMENT2_STR,
    @OUTOFSTANDARD_STR,
    @REPORTVALUE_STR,
    @MATERIALSNAME_STR,
    @EDITORIALRESULT_STR,
    @SPECIMENCOMMENTFLG_STR
)
SET
    -- VARCHAR型カラムの処理: 空文字列の場合NULLに変換
    PATIENTNO = NULLIF(@PATIENTNO_STR, ''),
    TESTITEMCODE = NULLIF(@TESTITEMCODE_STR, ''),
    TESTITEMNAME = NULLIF(@TESTITEMNAME_STR, ''),
    ADDCOMMENT1 = NULLIF(@ADDCOMMENT1_STR, ''),
    ADDCOMMENT2 = NULLIF(@ADDCOMMENT2_STR, ''),
    OUTOFSTANDARD = NULLIF(@OUTOFSTANDARD_STR, ''),
    REPORTVALUE = NULLIF(@REPORTVALUE_STR, ''),
    MATERIALSNAME = NULLIF(@MATERIALSNAME_STR, ''),
    EDITORIALRESULT = NULLIF(@EDITORIALRESULT_STR, ''),
    SPECIMENCOMMENTFLG = NULLIF(@SPECIMENCOMMENTFLG_STR, ''),

    -- DATE型カラムの処理: 空文字列の場合NULLに変換 (YYYYMMDD形式)
    COLLECTDATE = STR_TO_DATE(NULLIF(@COLLECTDATE_STR, ''), '%Y%m%d'),

    -- TIME型カラムの処理: 空文字列の場合NULLに変換 (HHMI形式)
    COLLECTTIME = STR_TO_DATE(NULLIF(@COLLECTTIME_STR, ''), '%H%i');


LOAD DATA INFILE '/tmp/CH_t16_一般検査_2024_納品.txt'
INTO TABLE 一般検査
CHARACTER SET CP932
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS
(
    @PATIENTNO_STR,
    @COLLECTDATE_STR,
    @COLLECTTIME_STR,
    @TESTITEMCODE_STR,
    @TESTITEMNAME_STR,
    @ADDCOMMENT1_STR,
    @ADDCOMMENT2_STR,
    @OUTOFSTANDARD_STR,
    @REPORTVALUE_STR,
    @MATERIALSNAME_STR,
    @EDITORIALRESULT_STR,
    @SPECIMENCOMMENTFLG_STR
)
SET
    -- VARCHAR型カラムの処理: 空文字列の場合NULLに変換
    PATIENTNO = NULLIF(@PATIENTNO_STR, ''),
    TESTITEMCODE = NULLIF(@TESTITEMCODE_STR, ''),
    TESTITEMNAME = NULLIF(@TESTITEMNAME_STR, ''),
    ADDCOMMENT1 = NULLIF(@ADDCOMMENT1_STR, ''),
    ADDCOMMENT2 = NULLIF(@ADDCOMMENT2_STR, ''),
    OUTOFSTANDARD = NULLIF(@OUTOFSTANDARD_STR, ''),
    REPORTVALUE = NULLIF(@REPORTVALUE_STR, ''),
    MATERIALSNAME = NULLIF(@MATERIALSNAME_STR, ''),
    EDITORIALRESULT = NULLIF(@EDITORIALRESULT_STR, ''),
    SPECIMENCOMMENTFLG = NULLIF(@SPECIMENCOMMENTFLG_STR, ''),

    -- DATE型カラムの処理: 空文字列の場合NULLに変換 (YYYYMMDD形式)
    COLLECTDATE = STR_TO_DATE(NULLIF(@COLLECTDATE_STR, ''), '%Y%m%d'),

    -- TIME型カラムの処理: 空文字列の場合NULLに変換 (HHMI形式)
    COLLECTTIME = STR_TO_DATE(NULLIF(@COLLECTTIME_STR, ''), '%H%i');


SELECT * FROM 一般検査 LIMIT 10;
