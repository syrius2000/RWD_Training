---
title: "CSVからインポートし重複削除まで行うSQL生成"
description: "CSVサンプルを基に、一時テーブルへのデータロード、重複排除、最終テーブル作成までの一連のSQLを生成します。"
mode: agent
---

### 概要
このプロンプトは、CSVファイルからデータをデータベースに取り込み、重複を除いたクリーンなテーブルを作成するまでの一連のSQL文を自動生成するためのものです。

### ワークフロー
1.  **一時テーブルの作成**: CSVの構造に基づいた `CREATE TABLE` 文を生成します。テーブル名は `[ファイル名]_staging` となります。
2.  **データロード**: 生成した一時テーブルにCSVデータを投入する `LOAD DATA INFILE` 文を生成します。
3.  **本番テーブルの作成**: 一時テーブルから重複行を削除したデータを `SELECT DISTINCT` を使って新しいテーブル（これが最終的なテーブル）に格納します。テーブル名は `[ファイル名]` となります。
4.  **重複行の確認 (任意)**: どのデータが重複していたかを確認するための参考クエリを生成します。
5.  **クリーンアップ**: 最後に一時テーブルを削除します。

### 使い方
1.  作成したいSQLファイルを開きます。
2.  そのファイルに、ヘッダー行を含む3〜4行のCSVサンプルを記述または貼り付けます。
3.  ヘッダー行とデータ行を選択し、このプロンプトを実行します。

### 要件:
1.  **データベース名**: `VACCINE` を使用してください。
2.  **テーブル名**:
    *   `{{file}}` のファイル名（拡張子なし）をベースに使用します。（例: `t01_patients.csv` の場合）
    *   **一時テーブル**: `[ファイル名]_staging` (例: `t01_patients_staging`)
    *   **本番テーブル**: `[ファイル名]` (例: `t01_patients`)
3   **データ型の推測ルール**:
    *   データサンプルから `DATE` 型または `DATETIME` 型に見えるカラムを推測してください。
    *   上記以外のカラムは、たとえ数値に見えても**全て `VARCHAR(255)`** として定義してください。`INT` や `DECIMAL` は使用しないでください。
    *   主キーやインデックスは不要です。
4.  **`CREATE TABLE` 文 (一時テーブル用)**:
    *   CSVのヘッダー行をカラム名としてください。
    *   **カラム名のサニタイズ**: SQLで無効な文字（スペース、括弧等）はアンダースコア `_` に置き換えてください。
    *   **データ型**: `DATE` or `DATETIME` に見えるもの以外は、全て `VARCHAR(255)` としてください。
5.  **`LOAD DATA INFILE` 文**:
    *   `{{file}}` をファイルパスとして使用してください。なければ`/tmp/mydata.csv`のように仮記載します。
    *   `IGNORE 1 LINES` を指定してください。
    *   文字セットは `cp932` を推奨し、`/* 文字コードはファイルに合わせて utf8 などに変更 */` というコメントを添えてください。
    *   **日付/日時カラムの特別処理**: `STR_TO_DATE(NULLIF(@var, ''), '【推測した日付書式】')` を使って、CSV内の日付書式を正確に検出し、正しく変換してください。
6.  **`CREATE TABLE AS SELECT` (本番テーブル用)**:
    *   `CREATE TABLE [本番テーブル名] AS SELECT DISTINCT * FROM [一時テーブル名];` という形式で、一時テーブルから重複を除いた本番テーブルを作成してください。
7.  **重複行の確認クエリ (参考)**:
    *   `-- 参考: 重複していた行を確認するクエリ` というコメントを付けてください。
    *   `SELECT *, COUNT(*) FROM [一時テーブル名] GROUP BY [全カラム] HAVING COUNT(*) > 1;` のような形式で、どの行が重複していたかを確認できるSQLを提示してください。
8.  **`DROP TABLE` 文**:
    *   最後に `DROP TABLE IF EXISTS [一時テーブル名];` を追加して後片付けをしてください。
9.  **出力形式**:
    *   生成された一連のSQL文を、1つのSQLコードブロックとして出力してください。
    *   各SQL文の最後にはセミコロン `;` を付けてください。

### ファイル情報
- **ファイルパス**: `{{file}}`
´´´ selection
{{selection}}
´´´

### へッダーとサンプルデータ
-  SQLコメント行の一行目はテーブルのカラム名でそれ以下はデータのサンプルである。SQL作成時データ型を正しくk推論する。